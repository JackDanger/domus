# Domus Template Sensors for Home Assistant
# 
# These sensors derive high-level house states from raw entity data.
# The Domus frontend reads only these derived states, keeping the
# frontend simple and logic-free.
#
# INSTALLATION:
# 1. Copy this file to your Home Assistant config directory
# 2. Add the following to your configuration.yaml:
#
#    template: !include template_sensors.yaml
#
# 3. Restart Home Assistant
# 4. Verify sensors appear in Developer Tools → States
#
# CUSTOMIZATION:
# Update entity_id references to match your actual devices.

- sensor:
    # =========================================================================
    # HOUSE ACTIVITY STATE
    # =========================================================================
    # Tracks how many people are home.
    #
    # States: empty | one | both
    #
    - name: "House Activity State"
      unique_id: domus_house_activity_state
      state: >
        {% set you_home = is_state('person.you', 'home') %}
        {% set partner_home = is_state('person.partner', 'home') %}
        
        {% if you_home and partner_home %}
          both
        {% elif you_home or partner_home %}
          one
        {% else %}
          empty
        {% endif %}
      icon: >
        {% if this.state == 'empty' %}
          mdi:home-outline
        {% elif this.state == 'both' %}
          mdi:home-account
        {% else %}
          mdi:home
        {% endif %}

    # =========================================================================
    # HOUSE DAY STATE
    # =========================================================================
    # Derives time-of-day state from the sun entity.
    #
    # States: day | night | twilight
    #
    - name: "House Day State"
      unique_id: domus_house_day_state
      state: >
        {% set sun_state = states('sun.sun') %}
        {% set elevation = state_attr('sun.sun', 'elevation') | float(0) %}
        
        {# Twilight is defined as sun elevation between -6° and 6° #}
        {% if sun_state == 'below_horizon' %}
          {% if elevation > -6 %}
            twilight
          {% else %}
            night
          {% endif %}
        {% else %}
          {% if elevation < 6 %}
            twilight
          {% else %}
            day
          {% endif %}
        {% endif %}
      icon: >
        {% if this.state == 'day' %}
          mdi:weather-sunny
        {% elif this.state == 'night' %}
          mdi:weather-night
        {% else %}
          mdi:weather-sunset
        {% endif %}


# =============================================================================
# PLACEHOLDER SENSORS (for development/testing)
# =============================================================================
# If you want to manually test different states, uncomment these input_select
# helpers and use them instead.
#
# Add to configuration.yaml:
#
# input_select:
#   domus_test_activity:
#     name: "Test Activity State"
#     options:
#       - empty
#       - one
#       - both
#     initial: one
#
#   domus_test_day:
#     name: "Test Day State"
#     options:
#       - day
#       - twilight
#       - night
#     initial: day
#
# Then create template sensors that mirror these for testing:
#
# - sensor:
#     - name: "House Activity State"
#       unique_id: domus_house_activity_state
#       state: "{{ states('input_select.domus_test_activity') }}"
#
#     - name: "House Day State"
#       unique_id: domus_house_day_state
#       state: "{{ states('input_select.domus_test_day') }}"
